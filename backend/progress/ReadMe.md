## progressApi - a RESTful web service

This folder contains the implementation of `progressApi`, a RESTful service of [gae-progress](../../).

Once the backend server is up and running you can explore the API using Google API Explorer. It's accessible from `http://localhost:8080/_ah/api/explorer`. Alternatively you can browse the [live API](https://progress-1181.appspot.com/_ah/api/explorer).

#### Methods
The `progressApi` provides the following methods
  - `create`, `update`, `delete` for modifying progresses.
  - `list` for querying progresses.
  - `userProfile`, `generateNewApiKey` for managing user related properties.

#### Entities

From a database perspective `progressApi` modifies two kinds of entities: `User` and `Progress`. The `User` entity holds sensitive user information such as E-Mail address and API key.
```python
class User(ndb.Model):
    email = ndb.StringProperty()
    apikey = ndb.StringProperty()
```

The `Progress` entity stores information on individual progresses.
```python
class Progress(ndb.Model):
    title = ndb.StringProperty()
    description = ndb.StringProperty()
    progress = ndb.FloatProperty(default=0.0)
    created = ndb.DateTimeProperty(auto_now_add=True)
    lastUpdated = ndb.DateTimeProperty(auto_now=True)
```

#### Keys

We will use the MD5 hashed E-Mail address as the key for `User`. Although this bears the small chance of generating duplicate keys, it provides some benefits when dealing with API keys as we will see in the [Authentication](#Authentication) section. Also note, the OpenID Connect protocol provides a unique user id that could be used instead.

We let the datastore automatically generate unique ids used as keys for `Progress` entities. As progresses are created by specific users, we require that a `Progress` key needs to have a `User` key as parent (see [ancestor relationship](https://cloud.google.com/appengine/docs/python/ndb/entities) for more info). `Progress` IDs generated by the datastore will only be unique in the context of a parent `User` key.

#### Messages
Each method provided by `progressApi` requires request and response messages. In Google Endpoints these are modelled using [Google Protocol Buffers](https://developers.google.com/protocol-buffers/), a framework that provides flexible message serialization in multiple languages. All messages can be found in [models.py](models.py).


#### Authentication <a name="Authentication"></a>

`progressApi` supports OpenID Connect for user authentication. Once a user authenticates, the user is fetched from the known `User` entities. If the user is not found in the datastore, a new `User` will be created on the fly. This way, sign up and sign in are actually one step.

There are a number of steps involved in authentication via OpenID Connect, a fact that could throw of users from using your API as developing clients becomes too complex. As a consequence each `User` is also assigned an API key that can be used as an alternative way of authentication.

The API key is randomly generated id that can be passed along with each `progressApi` request. When the backend API detects that an API key is present on a request, it looks up the corresponding `User` and verifies that the two API keys match.

The API key is a string assembled from two parts: `User-UUID`. The former part is the MD5 hashed E-Mail address of the user and the latter part is a [Universally unique identifier](https://en.wikipedia.org/wiki/Universally_unique_identifier). Encoding the user information in the API key has the advantage to be able to directly lookup the `User` entity via it's key, compared to a costly query. Since the E-Mail is not encoded directly, we don't expose sensitive information.

The responsible function for looking up users from OpenID Connect or API keys is `getUser` in [api.py](api.py).

#### Authorization

Authenticated users (either via OpenID Connect or API key) are authorized to create new progresses and manipulate their own progresses.

`progressApi` will respond with an error code `401 - Unauthorized` when authorization fails.
